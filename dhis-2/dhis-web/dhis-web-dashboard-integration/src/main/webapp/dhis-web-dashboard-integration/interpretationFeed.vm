#macro( getSymbol $ip )
#if( $ip.chartInterpretation )
<img src="../images/chart.png">
#elseif( $ip.mapInterpretation )
<img src="../images/map.png">
#elseif( $ip.reportTableInterpretation )
<img src="../images/table.png">
#elseif( $ip.dataSetReportInterpretation )
<img src="../images/dataset.png">
#end
#end

<script>
jQuery(function() {
  var dropDown = jQuery('.dropDown');

  jQuery('.gearDropDown').on('click', function( e ) {
    var jqTarget = jQuery(e.target);

    while( !jqTarget.hasClass('gearDropDown') ) {
      jqTarget = jqTarget.parent();
    }

    jqTarget.addClass('active');

    dropDown.show();

    dropDown.css({
      top: jqTarget.offset().top + jqTarget.innerHeight(),
      left: jqTarget.offset().left
    });

    return false;
  });

  jQuery(document).on('click', function() {
    if( dropDown.is(":visible") ) {
      jQuery('.gearDropDown').removeClass('active');
      dropDown.hide();
    }
  });
});
</script>

<style>
.gearDropDown {
  background-color : #f7f7f7;
  float            : right;
  border           : 1px solid #eaeaea;
  padding          : 4px 10px;
  cursor           : pointer;
  border-top-left-radius  : 3px;
  border-top-right-radius : 3px;
}

.gearDropDown.active {
  background-color : #ddd;
}

.dropDown {
  position                   : absolute;
  display                    : none;
  font-size                  : 9pt;
  color                      : #000;
  border                     : 1px solid #ddd;
  padding-left               : 2px;
  padding-right              : 2px;
  width                      : 70px;
  max-height                 : 610px;
  overflow-y                 : auto;
  background-color           : #f7f7f7;
  z-index                    : 10;
  border-bottom-left-radius  : 3px;
  border-bottom-right-radius : 3px;
  box-shadow                 : #ccc 0 1px 1px 0;
}

.dropDown > ul {
  margin: 6px 0;
}

.dropDown > ul > li {
  list-style-type : none;
  padding         : 100;
  margin          : 5px 0;
}

.dropDown > ul > li > a {
  display       : block;
  padding       : 5px 5px;
  color         : #000;
  border-radius : 3px;
  cursor        : pointer;
}

.dropDown > ul > li > a:hover {
  text-decoration  : none;
  background-color : #eee;
}

</style>

#macro( gearDropDown )
<div class="gearDropDown">
  <span><i class="fa fa-gear"></i> <i class="fa fa-caret-down"></i></span>
</div>
#end

<div class="dropDown">
  <ul>
    <li><a>Edit</a></li>
    <li><a>Delete</a></li>
  </ul>
</div>

#set( $maxComments = 4 )
#foreach( $ip in $interpretations )
<div class="interpretationContainer">
    #if( $ip.organisationUnit )#set( $ou = "&ou=" + $ip.organisationUnit.uid )#else#set( $ou = "" )#end
    #if( $ip.period )#set( $pe = "&pe=" + $ip.period.isoDate )#else#set( $pe = "" )#end

    <div class="interpretation">
	    <div class="interpretationName">
	    	<div class="interpretationSymbol">
	    	  #getSymbol( $ip )
	    	</div>
	    	<div class="interpretationUser">
           <a class="bold userLink" href="profile.action?id=${ip.user.uid}">${encoder.htmlEncode( $ip.user.name )}</a><br>
           <span class="tipText">${format.formatDate( $ip.created )}</span>
        </div>
        #gearDropDown()
	    </div>
	    <div class="interpretationText">
	        $!dhisTextUtils.htmlify( ${ip.text} )
	    </div>
	    <div class="interpretationItem">
	    #if( $ip.chartInterpretation )
	        <a href="../dhis-web-visualizer/app/index.html?id=${ip.chart.uid}&date=${format.formatDate( $ip.created )}">
	        <img style="cursor:pointer"
	            src="../api/charts/${ip.chart.uid}/data?date=${format.formatDate( $ip.created )}&width=558&height=300${ou}"
	            title="$i18n.getString( 'click_to_view_in_data_visualizer' )"></a>
	    #elseif( $ip.mapInterpretation )
	        <a href="../dhis-web-mapping/app/index.html?id=${ip.map.uid}">
	        <img style="cursor:pointer"
	            src="../api/maps/${ip.map.uid}/data?date=${format.formatDate( $ip.created )}&width=558"
	            title="$i18n.getString( 'click_to_view_in_gis' )"></a>
	    #elseif( $ip.reportTableInterpretation )
	        <a class="bold"
	           title="$i18n.getString( 'click_to_view_report_table' )"
	           href="../dhis-web-pivot/app/index.html?id=${ip.reportTable.uid}${pe}${ou}">
	           $encoder.htmlEncode( $ip.reportTable.name )</a>
	    #elseif( $ip.dataSetReportInterpretation )
	        <a class="bold"
	           title="$i18n.getString( 'click_to_view_data_set_report' )"
	           href="../dhis-web-reporting/showDataSetReportForm.action?ds=${ip.dataSet.uid}&pe=${ip.period.isoDate}&ou=${ip.organisationUnit.uid}">
	           $encoder.htmlEncode( $ip.dataSet.name )</a>
	    #end
	    </div>

	    #set( $comments = $ip.comments )
	    #set( $commentStartPos = ( $comments.size() - $maxComments ) )
	    <div class="interpretationCommentArea">
	        #if( $comments.size() > $maxComments )
	        <div id="commentHeader${ip.uid}" class="interpretationCommentHeader"><a href="javascript:expandComments( '${ip.uid}' )">View all $comments.size() comments</a></div>
        	#end
        	<div id="comments${ip.uid}">
	        #foreach( $comment in $comments )
	        <div #if( $velocityCount <= $commentStartPos ) style="display:none"#end>
	            <div class="interpretationName">
	                <a class="bold userLink" href="profile.action?id=${comment.user.uid}">${comment.user.name}</a>&nbsp;
	                <span class="grey">${format.formatDate( $comment.created )}</span>
	            </div>
		        <div class="interpretationText">
		            $!dhisTextUtils.htmlify( ${comment.text} )
		        </div>
            </div>
	        #end
	        </div>
	        <textarea id="commentArea${ip.uid}" class="commentArea" placeholder="$i18n.getString( 'add_a_comment' )..."></textarea>
	        <input type="button" class="commentButton" value="Post comment" onclick="postComment( '${ip.uid}' )">
	    </div>
    </div>
</div>
#end