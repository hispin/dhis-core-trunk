<script type="text/javascript">
	jQuery(document).ready(	function(){
		$('#smsManagementForm').tabs();
		validation( 'sendSMSForm', function(form){
			sendSMS();
		});
		setFieldValue('programStageName', "$programStageInstance.programStage.name");
	});
</script>

<h4>$programStageInstance.programStage.name</h4>

<input type='hidden' id='currentUsername' name='currentUsername' value='$currentUsername'>
<input type='hidden' id='programInstanceId' name='programInstanceId' value='$programStageInstance.programInstance.id'>
<table>
	<tr>            
		<td class="bold">$i18n.getString( "full_name" ):</td>
		<td>$programStageInstance.programInstance.patient.getFullName()<td>
	</tr>
	<tr>            
		<td class="bold">$i18n.getString( "gender" ):</td>
		<td>$programStageInstance.programInstance.patient.gender<td>
	</tr>
	<tr>
		<td class="bold">$i18n.getString( "date_of_birth" ):</td>
		<td>$format.formatDate( $programStageInstance.programInstance.patient.birthDate )<td>
	</tr>
	<tr>
		<td class="bold">$i18n.getString( "age" ):</td>
		<td>$programStageInstance.programInstance.patient.getAge()<td>
	</tr>
	<tr>
		<td class="bold">$i18n.getString("phone_number")</td>
		<td>
			#if($!programStageInstance.programInstance.patient.phoneNumber && $!programStageInstance.programInstance.patient.phoneNumber!='')
				$!programStageInstance.programInstance.patient.phoneNumber
			#else
				[$i18n.getString('none')]
			#end
		</td>
	</tr>
	<tr>
		<td>$i18n.getString("health_worker")</td>
		<td>
			#if($!programStageInstance.programInstance.patient.healthWorker )
				$!programStageInstance.programInstance.patient.healthWorker.name
			#else
				[$i18n.getString('none')]
			#end
		</td>
	</tr>
	<tr>
		<td>
			<br><input type='button' value='$i18n.getString("back")' onclick='onClickBackBtn();'>
			<input type='button' value='$i18n.getString("patient_dashboard")' onclick='javascript:showPatientProgramTracking( "$programStageInstance.programInstance.id" );'>
		</td>
	</tr>
</table>

<div id="smsManagementForm">
	<ul>
		<li><a href="#tab-1">$i18n.getString("reschedule_and_set_status")</a></li>
		<li><a href="#tab-3">$i18n.getString("send_sms")</a></li>
		<li><a href="#tab-2">$i18n.getString("tracking_history")</a></li>
	</ul>
	
	<div id="tab-1">
		<table class='mainPageTable' id='progarmStageListDiv' name='progarmStageListDiv' >
				<tr>
					<th></th>       
					<th>$i18n.getString( "operation" )</th>
				</tr>
			<tr>
				<td>$i18n.getString( "reschedule_due_date" )</td>        
				#set( $duedateId = "value_" + $programStageInstance.id + "_date" )        
				<td>        
					<input type="text" id="$duedateId" value="$!format.formatDate( $programStageInstance.dueDate )" onchange="saveDueDate( $programStageInstance.id, '$encoder.jsEncode( $programStageInstance.programStage.name )' )" />
					<input type="hidden" name="enrollmentDate" id="enrollmentDate" value="$!format.formatDate( $programInstance.enrollmentDate )">
					<input type="hidden" name="dateOfIncident" id="dateOfIncident" value="$!format.formatDate( $programInstance.dateOfIncident )">
					<script type="text/javascript">
						datePicker( '$duedateId' );
					</script> 
				</td> 
			</tr>
			<tr>
				<td>$i18n.getString( "status" )</td>
				<td>
					<select id="stat_$programStageInstance.id" name="status_$programStageInstance.id" onchange="setEventStatus(this, $programStageInstance.id)">
						<option value='5'>$i18n.getString("unknown")</option>
						<option value='1'>$i18n.getString("completed")</option>
						<option value='2'>$i18n.getString("incompleted")</option>
						<option value='6'>$i18n.getString("skipped")</option>
					</select>
						<script>
							var status = $programStageInstance.getEventStatus(); 
							setFieldValue("stat_$programStageInstance.id", status);
						</script>
				</td>
			</tr>
			<tr>
				<td>$i18n.getString( "post_comment" )</td>
				<td>
					<input type='text' id='commentText' name='commentText' onkeypress="keypress(event,this,'$programStageInstance.id')">
					<input type='button' value="+" class='tiny-button' title='$i18n.getString("post_comment")' onclick="addComment(this,'$programStageInstance.id')">
				</td>
			</tr>
			
			#if($programStageInstance.irregular!='true')
			<tr>
				<td>
					<input type="hidden" value="$i18n.getString('remove_this_event')" onclick="javascript:removeEvent($programStageInstance.id)" title='$i18n.getString( "remove_this_event" )'></a>
				</td>
			</tr>
			#end
		</table>
	</div>
	
	<div id="tab-2">
		<table class="mainPageTable">
			<col width="160px"/>
			<col width="300px"/>
			<col/>
			<tr><td>&nbsp;</td></tr>
			<tr>
				<th>$i18n.getString( "date" )</th>
				<th>$i18n.getString( "program_stage" )</th>
				<th>$i18n.getString( "message" )</th>
			</tr>
			
			<tbody id='commentTB'>
				#set($index = 0)
				#set( $mark = false )
				#foreach( $comment in $comments )
					#if( $index < 5 )
						<tr id="comment_$comment.id" #alternate($mark)>
							<td>$format.formatDate($comment.createdDate)</td>
							<td>$programStageInstance.programStage.name</td>
							<td>$comment.creator - $comment.commentText</td>
							#set($index = $index + 1)
							#set( $mark = !$mark)
						</tr>
					#end
				#end
			</tbody>	
			
			<tbody id='smsManagementList'>
				  #foreach( $sms in $outboundSms )
					#if( $index < 5 )
						<tr id="tr${sms.id}" #alternate($mark) >
							<td>$format.formatDate($!sms.date)</td>
							<td> $programStageInstance.programStage.name</td>
							<td>$sms.message</td>
							#set( $mark = !$mark)
						</tr>
					#end
				#end
			</tbody>
			
			<tbody id='moreComments' class='hidden'>
				#foreach( $comment in $comments )
					#if( $index >= 5 )
						<tr id="comment_$comment.id" #alternate($mark)>
							<td>$format.formatDate($comment.createdDate)</td>
							<td> $programStageInstance.programStage.name</td>
							<td>$comment.creator - $comment.commentText</td>
							#set( $mark = !$mark)
						</tr>
					#end
				#end	
				
				#foreach( $sms in $outboundSms )
					#if( $index >= 5 )
						<tr id="tr${sms.id}" #alternate($mark) >
							<td>$format.formatDate($!sms.date)</td>
							<td>$programStageInstance.programStage.name</td>
							<td>$sms.message</td>
							#set( $mark = !$mark)
						</tr>
					#end
				#end
			</tbody>
		</table>
		<br>
		<input type='button' value='$i18n.getString("show_hide_more")' onclick='jQuery("#moreComments").toggle();'>
	</div>
	
	<div id="tab-3">
		#parse( "/dhis-web-caseentry/sendSmsForm.vm" )
	</div>
	
</div>

<script type="text/javascript">
	jQuery(document).ready(	function(){
		var i18n_color_quick_help = '$encoder.jsEscape( $i18n.getString( "color_quick_help" ) , "'")';
		var i18n_comment_added = '$encoder.jsEscape( $i18n.getString( "comment_added" ) , "'")';
		setFieldValue( "programStageInstanceId", "$!programStageInstance.id" );
	});
	
</script>
