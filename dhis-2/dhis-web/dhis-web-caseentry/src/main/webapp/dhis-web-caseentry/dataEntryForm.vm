<script>
	jQuery("#entryFormContainer").ready(function(){
	
		#if( $programStageInstance )
			setFieldValue( 'dueDate', "$!format.formatDate( $programStageInstance.dueDate )" );
			setFieldValue( 'executionDate', "$!format.formatDate( $programStageInstance.executionDate )" );
		#elseif( $program.singleEvent == "true" )
		{
			disable("dueDate");
		}
		#end
		
		$('#executionDate').change(function() {
				saveExecutionDate( getFieldValue('programStageId'), getFieldValue('executionDate') );
			});
			
		if( getFieldValue('programStageId') == 0 )
		{
			disable('executionDate');
		}
		else
		{
			enable('executionDate');
		}
		entryFormContainerOnReady();
	});
</script>

<div id='entryFormContainer'>

<input type='hidden' id='incidentDate' value='$!format.formatDate($programStageInstance.programInstance.dateOfIncident)'>
<input type='hidden' name='programStageInstanceId' id='programStageInstanceId' value='$!programStageInstance.id'>
<input type='hidden' name='programInstanceId' id='programInstanceId' value='$!programStageInstance.programInstance.id'>
<input type='hidden' name='irregular' id='irregular' value='$!programStageInstance.programStage.irregular'>
<input type='hidden' name='completed' id='completed' value='$!programStageInstance.completed'>

<div id='entryForm' style="display: #if($!programStageInstance.executionDate) block #else none #end;">
	#if( $customDataEntryFormCode )
		<div id="customEntryScreenContainer">
		   $customDataEntryFormCode

			<script type="text/javascript"> 
				#if( $!programStageInstance.programStage.program.anonymous == 'false' )
					initCustomCheckboxes();
				#end
			</script>
		</div>
	#else
		<div id="defaultEntryScreenContainer" >

			<table class="mainPageTable">
				<col id="noCol">
				<col id="deCol">    
				<col id="entryCol">
				#if( $programStageInstance.programInstance.program.anonymous == 'false' )
				<col id="facilityCol">       
				#end
				<tr>
					<th>$i18n.getString( "nr" )</th>
					<th>$i18n.getString( "data_element" )</th>                   
					<th>$i18n.getString( "entry" )</th>
					#if( $programStageInstance.programInstance.program.anonymous == 'false' )
						<th>$i18n.getString( "provided_elsewhere" )</th>             
					#end
				</tr>
			#set( $dataElementRowCount = 0 )
			#set( $mark = 0 )
			#set( $tabIndex = 1 )
			#foreach( $programStageDataElement in $programStageDataElements )
				#set( $dataElementRowCount = $dataElementRowCount + 1 )    
				#if( $mark == 1 )
					#set( $mark = 0 )
				#else
					#set( $mark = 1 )
				#end    
				#set( $patientDataValue = false )
				#set( $patientDataValue = $patientDataValueMap.get( $programStageDataElement.dataElement.id ) )    
				<tr #if( $mark == 0 ) style="background-color:#dddddd" #end>
					##dataElementRowCount
					<td style="text-align:right">$dataElementRowCount</td>        
					##data element name
					<td>
						<span id="value[$programStageDataElement.dataElement.id].name" title="$!encoder.htmlEncode( $programStageDataElement.dataElement.description )">
							$encoder.htmlEncode( $programStageDataElement.dataElement.name ) 
							#if ( $programStageDataElement.compulsory )
								<em title="$i18n.getString( "required" )" class="required">*</em>
							#end        
						</span>
					</td>        
					##type        
					<td style="display:none"><span id="value[$programStageDataElement.dataElement.id].type" style="display:none">$encoder.htmlEncode( $programStageDataElement.dataElement.type )</span></td>       
					##entry        
					<td>   
						#set( $id = $programStageDataElement.programStage.id + '-' + $programStageDataElement.dataElement.id + '-val' )
						#if( $programStageDataElement.dataElement.type == "bool" )
							<select name="entryselect" #if($programStageInstance.completed) disabled="disabled" #end data="{compulsory: $programStageDataElement.compulsory }" id="$id" onchange="saveOpt( $programStageDataElement.dataElement.id )" tabindex="$tabIndex" style="text-align:center;"> 
								<option value="">[$i18n.getString( "select_value" )]</option>
								<option value="true" #if( $patientDataValue.value == "true" ) selected="selected" #end>$i18n.getString( "yes" )</option>
								<option value="false" #if( $patientDataValue.value == "false" ) selected="selected" #end>$i18n.getString( "no" )</option>
							</select>                              
						#elseif( $programStageDataElement.dataElement.type == "string" && $programStageDataElement.dataElement.isMultiDimensional() )
							#set( $optionValues = $optionMap.get( $programStageDataElement.dataElement.id ) )
							<select name="entryselect" data="{compulsory: $programStageDataElement.compulsory }" #if($programStageInstance.completed) disabled="disabled" #end id="$id" onchange="saveOpt( $programStageDataElement.dataElement.id )" tabindex="$tabIndex" style="text-align:center;">              
								<option value="">[$i18n.getString( "no_value" )]</option>
								#foreach( $optionValue in $optionValues )
									<option value="$optionValue.id" #if( $patientDataValue.value == $optionValue.id ) selected="selected" #end>$encoder.htmlEncode( $optionValue.name )</option>
								#end
							</select>
						#elseif( $programStageDataElement.dataElement.type == "date" )
							<input type="text" data="{compulsory: $programStageDataElement.compulsory }" #if($programStageInstance.completed) disabled="disabled" #end id="$id" name="entryfield" value="$!encoder.htmlEncode( $patientDataValue.value )" onchange="saveDate( $programStageDataElement.dataElement.id )" onkeypress="return keyPress(event, this)" tabindex="$tabIndex"  style="text-align:center;">
							#if(!$programStageInstance.completed)
								<script type="text/javascript">
									datePicker($programStageDataElement.programStage.id + '-' + $programStageDataElement.dataElement.id + '-val', false);
								</script>   
							#end
						#else
							#foreach( $optionCombo in $programStageDataElement.dataElement.categoryCombo.optionCombos )
								#set( $id = $programStageDataElement.programStage.id + '-' + $programStageDataElement.dataElement.id + '-' + $optionCombo.id + '-val' )
								<input name="entryfield" data="{compulsory: $programStageDataElement.compulsory, deName:'$programStageDataElement.dataElement.name', deType:'$programStageDataElement.dataElement.getDetailedNumberType()' }" #if($programStageInstance.completed) disabled="disabled" #end id="$id" type="text" value="$!encoder.htmlEncode( $patientDataValue.value )" onchange="saveVal( $programStageDataElement.dataElement.id, $optionCombo.id )" onkeypress="return keyPress(event, this)" tabindex="$tabIndex"  style="text-align:center;">
							#end
						#end
					</td>  
					
					
					##providedByAnotherFacility 
					#set( $id = $programStageDataElement.programStage.id + '_' + $programStageDataElement.dataElement.id + '_facility' )
					#if($programStageInstance.programInstance.program.anonymous == 'false') 					
					<td>   
						#if ( $patientDataValue.value )        
							#if( !$patientDataValue.providedByAnotherFacility )
								$patientDataValue.organisationUnit.name
								<input  name="providedByAnotherFacility" id="$id" type="hidden" onclick="updateProvidingFacility( $programStageDataElement.dataElement.id, this )" #if($programStageInstance.completed) disabled="disabled" #end >
							#else
								$i18n.getString("other_facility")
								<input  name="providedByAnotherFacility" id="$id" type="hidden" onclick="updateProvidingFacility( $programStageDataElement.dataElement.id, this )" #if($programStageInstance.completed) disabled="disabled" #end >
							#end
						 #else
							<input name="providedByAnotherFacility" id="$id" type="checkbox" onclick="updateProvidingFacility( $programStageDataElement.dataElement.id, this )" #if($programStageInstance.completed) disabled="disabled" #end >
						 #end                         
					</td>
					
					#else
						<input name="providedByAnotherFacility" id="$id" type="hidden">
                    #end					
				</tr>
				#set( $tabIndex = $tabIndex + 1 )
			#end
			</table>
		</div>
	#end
</div>

</div>

<div id='validateProgramDiv'></div>
