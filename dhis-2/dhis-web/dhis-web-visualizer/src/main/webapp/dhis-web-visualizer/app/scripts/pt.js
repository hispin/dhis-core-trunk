Ext.onReady( function() {


var pt = {};

pt.response = {
    "headers": [
		{
			"name": "de",
			"column": "de",
			"type": "java.lang.String",
			"hidden": false,
			"meta": true
		}, {
			"name": "coc",
			"column": "coc",
			"type": "java.lang.String",
			"hidden": false,
			"meta": true
		}, {
			"name": "pe",
			"column": "pe",
			"type": "java.lang.String",
			"hidden": false,
			"meta": true
		}, {
			"name": "ou",
			"column": "ou",
			"type": "java.lang.String",
			"hidden": false,
			"meta": true
		}, {
			"name": "J5jldMd8OHv",
			"column": "J5jldMd8OHv",
			"type": "java.lang.String",
			"hidden": false,
			"meta": true
						//index: 4
						//items: ['ImspTQPwCqd']
						//size: 1
		}, {
			"name": "value",
			"column": "Value",
			"type": "java.lang.Double",
			"hidden": false,
			"meta": false
		}
    ],
    "width": 6,
    "height": 24,
    "rows": [
        ["YtbsuPPo010", "V6L425pT3A0", "201201", "ImspTQPwCqd", "uYxK4wmcPqA", "456.0"],
        ["YtbsuPPo010", "V6L425pT3A0", "201202", "ImspTQPwCqd", "uYxK4wmcPqA", "876.0"],
        ["YtbsuPPo010", "V6L425pT3A0", "201203", "ImspTQPwCqd", "uYxK4wmcPqA", "821.0"],
        ["YtbsuPPo010", "V6L425pT3A0", "201204", "ImspTQPwCqd", "uYxK4wmcPqA", "567.0"],
        ["YtbsuPPo010", "V6L425pT3A0", "201201", "Jdj9kdfn93n", "uYxK4wmcPqA", "674.0"],
        ["YtbsuPPo010", "V6L425pT3A0", "201202", "Jdj9kdfn93n", "uYxK4wmcPqA", "866.0"],
        ["YtbsuPPo010", "V6L425pT3A0", "201203", "Jdj9kdfn93n", "uYxK4wmcPqA", "334.0"],
        ["YtbsuPPo010", "V6L425pT3A0", "201204", "Jdj9kdfn93n", "uYxK4wmcPqA", "254.0"],

        ["Vdjeu38jejd", "V6L425pT3A0", "201201", "ImspTQPwCqd", "uYxK4wmcPqA", "294.0"],
        ["Vdjeu38jejd", "V6L425pT3A0", "201202", "ImspTQPwCqd", "uYxK4wmcPqA", "663.0"],
        ["Vdjeu38jejd", "V6L425pT3A0", "201203", "ImspTQPwCqd", "uYxK4wmcPqA", "374.0"],
        ["Vdjeu38jejd", "V6L425pT3A0", "201204", "ImspTQPwCqd", "uYxK4wmcPqA", "765.0"],
        ["Vdjeu38jejd", "V6L425pT3A0", "201201", "Jdj9kdfn93n", "uYxK4wmcPqA", "375.0"],
        ["Vdjeu38jejd", "V6L425pT3A0", "201202", "Jdj9kdfn93n", "uYxK4wmcPqA", "287.0"],
        ["Vdjeu38jejd", "V6L425pT3A0", "201203", "Jdj9kdfn93n", "uYxK4wmcPqA", "699.0"],
        ["Vdjeu38jejd", "V6L425pT3A0", "201204", "Jdj9kdfn93n", "uYxK4wmcPqA", "883.0"],

        ["Wdsd99jdmmf", "V6L425pT3A0", "201201", "ImspTQPwCqd", "uYxK4wmcPqA", "475.0"],
        ["Wdsd99jdmmf", "V6L425pT3A0", "201202", "ImspTQPwCqd", "uYxK4wmcPqA", "264.0"],
        ["Wdsd99jdmmf", "V6L425pT3A0", "201203", "ImspTQPwCqd", "uYxK4wmcPqA", "233.0"],
        ["Wdsd99jdmmf", "V6L425pT3A0", "201204", "ImspTQPwCqd", "uYxK4wmcPqA", "445.0"],
        ["Wdsd99jdmmf", "V6L425pT3A0", "201201", "Jdj9kdfn93n", "uYxK4wmcPqA", "788.0"],
        ["Wdsd99jdmmf", "V6L425pT3A0", "201202", "Jdj9kdfn93n", "uYxK4wmcPqA", "854.0"],
        ["Wdsd99jdmmf", "V6L425pT3A0", "201203", "Jdj9kdfn93n", "uYxK4wmcPqA", "732.0"],
        ["Wdsd99jdmmf", "V6L425pT3A0", "201204", "Jdj9kdfn93n", "uYxK4wmcPqA", "726.0"]
    ],
    "metaData": {
        "YtbsuPPo010": "ANC 1 visit",
        "Vdjeu38jejd": "ANC 2 visit",
        "Wdsd99jdmmf": "ANC 3 visit",
        "V6L425pT3A0": "Default",
        "201201": "Jan 2012",
        "201202": "Feb 2012",
        "201203": "Mar 2012",
        "201204": "Apr 2012",
        "ImspTQPwCqd": "Kailahun CHPC",
        "Jdj9kdfn93n": "Bo CHPC",
        "uYxK4wmcPqA": "Public ownership"
    }

				//"nameHeaderMap": {
					//"de": <header.de>
					//"pe": <header.pe>
				//}
				//,

				//"idValueMap": {
					//"Vdjeu38jejd201201ImspTQPwCqdV6L425pT3A0": "294.0"
					//"Vdjeu38jejd201201Jdj9kdfn93nV6L425pT3A0": "375.0"
				//}
};

//pt.settings = {
	//col: ['pe', 'J5jldMd8OHv', 'ou', 'coc'],
	//row: ['de']
//};

var extendSettings = function(pt) {
	var settings = pt.settings,
		col = settings.col,
		row = settings.row;

	settings.dimensions = Ext.clone(col);
	Ext.apply(settings.dimensions, row);
};

var extendResponse = function(pt) {
	var response = pt.response,
		settings = pt.settings,
		dimensions = settings.dimensions,
		headers = response.headers,
		header,
		rows = response.rows,
		settingsDims = [],
		items;

	response.nameHeaderMap = {};
	response.idValueMap = {};

	// Header items, size. Response nameHeaderMap.
	for (var i = 0; i < headers.length; i++) {
		header = headers[i];
		header.index = i;
		items = [];

		for (var j = 0; j < rows.length; j++) {
			items.push(rows[j][header.index]);
		}

		header.items = Ext.Array.unique(items);
		header.size = header.items.length;

		response.nameHeaderMap[header.name] = header;
	}

	// Header items. SettingsDims array.
	for (var dim in dimensions) {
		if (dimensions.hasOwnProperty(dim)) {
			settingsDims.push(dim);

			response.nameHeaderMap[dim].items = dimensions[dim];
		}
	}

	// Response idValueMap
	for (var i = 0, id, valueIndex = response.nameHeaderMap.value.index; i < rows.length; i++) {
		id = '';

		for (var j = 0, dimIndex; j < settingsDims.length; j++) {
			dimIndex = response.nameHeaderMap[settingsDims[j]].index;
			id += rows[i][dimIndex];
		}

		response.idValueMap[id] = rows[i][valueIndex];
	}
};

var extendDims = function(aUniqueItems) {
	//aUniqueItems	= [ [de1, de2, de3],
	//					[p1],
	//					[ou1, ou2, ou3, ou4] ]

	var nCols = 1,
		aNumCols = [],
		aAccNumCols = [],
		aSpan = [],
		aGuiItems = [],
		aAllItems = [],
		aColIds = [];

	for (var i = 0, dim; i < aUniqueItems.length; i++) {
		nNumCols = aUniqueItems[i].length;

		aNumCols.push(nNumCols);
		nCols = nCols * nNumCols;
		aAccNumCols.push(nCols);
	}

console.log("");
console.log("aNumCols", aNumCols);
console.log("nCols", nCols);
console.log("aAccNumCols", aAccNumCols);

	//aNumCols		= [3, 1, 4]
	//nCols			= 12 (3 * 1 * 4)
	//aAccNumCols	= [3, 3, 12]

	for (var i = 0; i < aUniqueItems.length; i++) {
		aSpan.push(aNumCols[i] === 1 ? nCols : nCols / aAccNumCols[i]); //if one, span all
	}

console.log("aSpan", aSpan);

	//aSpan			= [10, 2, 1]

	aGuiItems.push(aUniqueItems[0]);

	if (aUniqueItems.length > 1) {
		for (var i = 1, a, n; i < aUniqueItems.length; i++) {
			a = [];
			n = aNumCols[i] === 1 ? 1 : aAccNumCols[i-1];

			for (var j = 0; j < n; j++) {
				a = a.concat(aUniqueItems[i]);
			}

			aGuiItems.push(a);
		}
	}

console.log("aGuiItems", aGuiItems);
	//aGuiItems	= [ [d1, d2, d3], (3)
	//				[p1, p2, p3, p4, p5, p1, p2, p3, p4, p5, p1, p2, p3, p4, p5], (15)
	//				[o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2...] (30)
	//		  	  ]


	for (var i = 0, dimItems, span; i < aUniqueItems.length; i++) {
		dimItems = [];
		span = aSpan[i];

		if (i === 0) {
			for (var j = 0; j < aUniqueItems[i].length; j++) {
				for (var k = 0; k < span; k++) {
					dimItems.push(aUniqueItems[i][j]);
				}
			}
		}
		else {
			var factor = nCols / aUniqueItems[i].length;

			for (var k = 0; k < factor; k++) {
				dimItems = dimItems.concat(aUniqueItems[i]);
			}
		}

		aAllItems.push(dimItems);
	}

console.log("aAllItems", aAllItems);
	//aAllItems	= [ [d1, d1, d1, d1, d1, d1, d1, d1, d1, d1, d2, d2, d2, d2, d2, d2, d2, d2, d2, d2, d3, d3, d3, d3, d3, d3, d3, d3, d3, d3], (30)
	//				[p1, p2, p3, p4, p5, p1, p2, p3, p4, p5, p1, p2, p3, p4, p5, p1, p2, p3, p4, p5, p1, p2, p3, p4, p5, p1, p2, p3, p4, p5], (30)
	//				[o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2, o1, o2] (30)
	//		  	  ]

	for (var i = 0, id; i < nCols; i++) {
		id = '';

		for (var j = 0; j < aAllItems.length; j++) {
			id += aAllItems[j][i];
		}

		aColIds.push(id);
	}

console.log("aColIds", aColIds);
	//aColIds	= [ aaaaaaaaBBBBBBBBccccccc, aaaaaaaaaccccccccccbbbbbbbbbb, ... ]


console.log("");
	return {
		items: {
			unique: aUniqueItems,
			gui: aGuiItems,
			all: aAllItems
		},
		ids: aColIds,
		span: aSpan,
		dims: aUniqueItems.length,
		size: nCols
	};
};

var getDims = function(pt) {
	var response = pt.response,
		settings = pt.settings,
		col = settings.col,
		row = settings.row,
		getUniqueColsArray,
		getUniqueRowsArray;

	getUniqueColsArray = function() {
		var a = [];

		for (var dim in col) {
			if (col.hasOwnProperty(dim)) {
				a.push(response.nameHeaderMap[dim].items);
			}
		}

		return a;
	};

	getUniqueRowsArray = function() {
		var a = [];

		for (var dim in row) {
			if (row.hasOwnProperty(dim)) {
				a.push(response.nameHeaderMap[dim].items);
			}
		}

		return a;
	};

	// aUniqueCols ->  [[p1, p2, p3], [ou1, ou2, ou3, ou4]]

	return {
		cols: extendDims(getUniqueColsArray()),
		rows: extendDims(getUniqueRowsArray())
	};
};

var extendRowDims = function(rows) {
	var all = rows.items.all,
		allObjects = [];

	for (var i = 0, allRow; i < all.length; i++) {
		allRow = [];

		for (var j = 0; j < all[i].length; j++) {
			allRow.push({
				id: all[i][j]
			});
		}

		allObjects.push(allRow);
	}

	for (var i = 0; i < allObjects.length; i++) {
		for (var j = 0, object; j < allObjects[i].length; j += rows.span[i]) {
			object = allObjects[i][j];
			object.rowSpan = rows.span[i];
		}
	}

	rows.items.allObjects = allObjects;
};

var getEmptyItem = function(pt) {
	return {
		colspan: pt.config.rows.dims,
		rowspan: pt.config.cols.dims,
		baseCls: 'empty'
	};
};

var getColItems = function(pt) {
	var response = pt.response,
		cols = pt.config.cols,
		colItems = [];

	for (var i = 0, dimItems, colSpan; i < cols.dims; i++) {
		dimItems = cols.items.gui[i];
		colSpan = cols.span[i];

		for (var j = 0, id; j < dimItems.length; j++) {
			id = dimItems[j];
			colItems.push({
				html: response.metaData[id],
				colspan: colSpan,
				baseCls: 'dim'
			});

			if (i === 0 && j === (dimItems.length - 1)) {
				colItems.push({
					html: 'Total',
					rowspan: cols.dims,
					baseCls: 'dimtotal'
				});
			}
		}
	}

	return colItems;
};

var getRowItems = function(pt) {
	var response = pt.response,
		rows = pt.config.rows,
		cols = pt.config.cols,
		size = rows.size,
		dims = rows.dims,
		allObjects = rows.items.allObjects,
		dimHtmlItems = [],
		valueItems = [],
		valueHtmlItems = [],
		totalRowItems = [],
		totalRowHtmlItems = [],
		totalColItems = [],
		totalColHtmlItems = [],
		grandTotalItem = 0,
		grandTotalHtmlItem;

	// Value items
	for (var i = 0, row; i < size; i++) {
		row = [];

		for (var j = 0, id, value, row; j < pt.config.cols.size; j++) {
			id = cols.ids[j] + rows.ids[i];
			value = parseFloat(response.idValueMap[id]);
			row.push(value);
		}

		valueItems.push(row);
	}

	// Value html items
	for (var i = 0, row; i < valueItems.length; i++) {
		row = [];

		for (var j = 0, id, value, cls; j < valueItems[i].length; j++) {
			id = cols.ids[j] + rows.ids[i];
			value = valueItems[i][j];
			//cls = value < 333 ? 'bad' : (value < 666 ? 'medium' : 'good'); //simplistic legendset

			row.push({
				id: id,
				value: value,
				html: value.toString(),
				baseCls: 'value'
				//cls: cls
			});
		}

		valueHtmlItems.push(row);
	}

	// Total row items
	for (var i = 0, rowSum; i < valueItems.length; i++) {
		rowSum = Ext.Array.sum(valueItems[i]);
		totalRowItems.push(rowSum);
	}

	// Total row html items
	for (var i = 0, rowSum; i < totalRowItems.length; i++) {
		rowSum = totalRowItems[i];

		totalRowHtmlItems.push({
			value: rowSum,
			html: rowSum.toString(),
			baseCls: 'valuetotal'
		});
	}

	// Total col items
	for (var i = 0, colSum; i < valueItems[0].length; i++) {
		colSum = 0;

		for (var j = 0; j < valueItems.length; j++) {
			colSum += valueItems[j][i];
		}

		totalColItems.push(colSum);
	}

	// Total col html items
	for (var i = 0, colSum; i < totalColItems.length; i++) {
		colSum = totalColItems[i];

		totalColHtmlItems.push({
			value: colSum,
			html: colSum.toString(),
			baseCls: 'valuetotal'
		});
	}

	// Grand total item
	grandTotalItem = Ext.Array.sum(totalColItems);

	// Grand total html item
	grandTotalHtmlItem = {
		value: grandTotalItem,
		html: grandTotalItem.toString(),
		baseCls: 'valuegrandtotal'
	};

	// GUI

	// Dim html items
	for (var i = 0; i < size; i++) {
		for (var j = 0, object; j < dims; j++) {
			object = allObjects[j][i];

			if (object.rowSpan) {
				dimHtmlItems.push({
					html: response.metaData[object.id],
					rowspan: object.rowSpan,
					baseCls: 'dim'
				});
			}
		}

		dimHtmlItems = dimHtmlItems.concat(valueHtmlItems[i]);
		dimHtmlItems = dimHtmlItems.concat(totalRowHtmlItems[i]);
	}

	// Final row
	dimHtmlItems.push({
		html: 'Total',
		colspan: rows.dims,
		baseCls: 'dimtotal'
	});

	dimHtmlItems = dimHtmlItems.concat(totalColHtmlItems);

	dimHtmlItems.push(grandTotalHtmlItem);

	return dimHtmlItems;
};

var createTableArray = function(pt) {
	var rowItems = [],
		panel = Ext.create('Ext.panel.Panel', {
			renderTo: Ext.get('pivottable'),
			layout: {
				type: 'table',
				columns: pt.config.cols.size + pt.config.rows.dims + 1
			},
			defaults: {
				baseCls: 'td'
			}
		});

	panel.add(getEmptyItem(pt));

	panel.add(getColItems(pt));

	panel.add(getRowItems(pt));
};

var initialize = function() {

	var params = '?&dimension=J5jldMd8OHv:CXw2yu5fodb,tDZVQ1WtwpA&dimension=de:fbfJHSPpUQD,cYeuwXTCPkU,Jtf34kNZhzP,hfdmMSPBgLG&dimension=pe:201201,201202,201203,201204';

	Ext.Ajax.request({
		method: 'GET',
		url: 'http://localhost:8080/api/analytics' + params,
		headers: {'Content-Type': 'application/json'},
		params: {
			filter: 'ou:ImspTQPwCqd',
			categories: false
		},
		success: function(r) {
			pt.response = Ext.decode(r.responseText);
		//}
	//});

    //de: ['YtbsuPPo010', 'Vdjeu38jejd', 'Wdsd99jdmmf'],

    //pe: ['201201', '201201', '201201', '201201'],
    //ou: ['ImspTQPwCqd', 'Jdj9kdfn93n']

			pt.settings = {
				col: {
					de: ['fbfJHSPpUQD', 'cYeuwXTCPkU', 'Jtf34kNZhzP', 'hfdmMSPBgLG']
				},
				row: {
					'J5jldMd8OHv': ['CXw2yu5fodb', 'tDZVQ1WtwpA'],
					pe: ['201201', '201202', '201203', '201204']
				}
			};

			extendSettings(pt);
			extendResponse(pt);

			pt.config = getDims(pt);
			console.log(pt);

			extendRowDims(pt.config.rows);

			var panel = createTableArray(pt);
		}
	});

}();

});
