<script type="text/javascript" src="../dhis-web-commons/i18nJavaScript.action"></script>
<script type="text/javascript" src="../dhis-web-commons/javascripts/jQuery/jquery.glob.js"></script>
<script type="text/javascript" src="../dhis-web-commons/javascripts/jQuery/jquery.date.js"></script>
<script type="text/javascript" src="../dhis-web-commons/javascripts/date.js"></script>
<script type="text/javascript" src="../../dhis-web-commons/javascripts/periodType.js"></script>

<script>
    var Selected = {};
    var periodTypeFactory = new PeriodType();
    var periodType;
    var periodOffset = 0;

    function selectOrganisationUnit( e ) {
        var $this = $(this);
        Selected.orgUnit = $this.data('id');
    }

    function selectDataSet( e ) {
        var $this = $(this);
        Selected.dataSet = $this.data('id');
    }

    function selectPeriod( e ) {
        var $this = $(this);
        Selected.period = $this.data('id');
    }

    function loadOrganisationUnitsPage() {
        $.mobile.showPageLoadingMsg();

        jQuery.ajax({
            url   : '$baseUrl/../api/currentUser/organisationUnits',
            dataType: 'json',
            data: {
              'withChildren': true
            }
        }).success(function ( data ) {
            var tmpl = jQuery('#organisation-units-template').html();

            jQuery('#organisation-units-page section[data-role="content"]').html(
                _.template( tmpl, { 'organisationUnits': data } )
            );

            jQuery('#organisation-unit-list').listview()
            jQuery('#organisation-unit-list li a').bind('click', selectOrganisationUnit);

            $.mobile.hidePageLoadingMsg();
        }).error(function () {
            $.mobile.showPageLoadingMsg( $.mobile.pageLoadErrorMessageTheme, "Unable to get organisationUnits", true );
            console.log('error fetching orgUnits')
        });
    }

    function loadDataSetsPage() {
        if(Selected.orgUnit === undefined)
        {
            $.mobile.changePage('#organisation-units-page');
            return;
        }

        $.mobile.showPageLoadingMsg();

        jQuery.ajax({
            url   : '$baseUrl/../api/currentUser/organisationUnits/' + Selected.orgUnit + '/dataSets',
            dataType: 'json'
        }).success(function ( data ) {
            var tmpl = jQuery('#data-sets-template').html();

            jQuery('#data-sets-page section[data-role="content"]').html(
                _.template( tmpl, { 'dataSets': data } )
            );

            jQuery('#data-set-list').listview();
            jQuery('#data-set-list li a').bind('click', selectDataSet);
            $.mobile.hidePageLoadingMsg();
        }).error(function () {
            $.mobile.showPageLoadingMsg( $.mobile.pageLoadErrorMessageTheme, "Unable to get dataSets", true );
            console.log('error fetching dataSets')
        });
    }

    function refreshPeriods() {
        var tmpl = jQuery('#period-template').html();

        var periods = periodTypeFactory.get(periodType).generatePeriods(periodOffset);
        periods = periodTypeFactory.filterFuturePeriodsExceptCurrent(periods)
        periods = periodTypeFactory.reverse(periods);
        jQuery('#period-page section[data-role="content"]').html(
                _.template(tmpl, { 'periods' : periods })
        );
        jQuery('#period-page').trigger('pagecreate')
        jQuery('#period-list').listview('refresh');

        jQuery('#previous_year').bind('click', function() {
            periodOffset--;
            refreshPeriods();
        });

        jQuery('#next_year').bind('click', function() {
            periodOffset++;
            refreshPeriods();
        });

        jQuery('#period-list li a').bind('click', selectPeriod);
    }

    function loadPeriodPage() {
        if(Selected.dataSet === undefined)
        {
            if(Selected.orgUnit === undefined) {
                $.mobile.changePage('#organisation-units-page');
            } else {
                $.mobile.changePage('#data-sets-page');
            }

            return;
        }

        $.mobile.showPageLoadingMsg();

        jQuery.ajax({
            url   : '$baseUrl/../api/dataSets/' + Selected.dataSet + '/form',
            dataType: 'json'
        }).success(function ( data ) {
            periodType = data.periodType;
            refreshPeriods();
            $.mobile.hidePageLoadingMsg();
        }).error(function () {
            $.mobile.showPageLoadingMsg( $.mobile.pageLoadErrorMessageTheme, "Unable to get form", true );
            console.log('error fetching form')
        });
    }

    function loadDataEntryPage() {
        if(Selected.period === undefined && Selected.dataSet === undefined && Selected.orgUnit === undefined )
        {
            $.mobile.changePage('#organisation-units-page');
            return;
        }

        if(Selected.period === undefined && Selected.dataSet === undefined && Selected.orgUnit !== undefined )
        {
            $.mobile.changePage('#data-sets-page');
            return;
        }

        if(Selected.period === undefined && Selected.dataSet !== undefined && Selected.orgUnit !== undefined )
        {
            $.mobile.changePage('#periods-page');
            return;
        }

        console.log(Selected);

        $.mobile.showPageLoadingMsg();

        jQuery.ajax({
            url   : '$baseUrl/../api/dataSets/' + Selected.dataSet + '/form',
            dataType: 'json'
        }).success(function ( data ) {
            console.log(data);

            var tmpl = jQuery('#data-entry-template').html();

            jQuery('#data-entry-page section[data-role="content"]').html(
                _.template( tmpl, data )
            );

            jQuery('#data-entry-page').trigger('pagecreate')
            jQuery('#data-entry-list').listview('refresh');
            $.mobile.hidePageLoadingMsg();
        }).error(function () {
            $.mobile.showPageLoadingMsg( $.mobile.pageLoadErrorMessageTheme, "Unable to get form", true );
            console.log('error fetching form')
        });
    }

    jQuery(document).bind('pagechange', function (event, data) {
        var pageId = data.toPage.attr('id');
        console.log(pageId);

        if( pageId == 'organisation-units-page' ) {
            loadOrganisationUnitsPage();
        } else if( pageId == 'data-sets-page' ) {
            loadDataSetsPage();
        } else if( pageId == 'period-page' ) {
            loadPeriodPage();
        } else if( pageId == 'data-entry-page' ) {
            loadDataEntryPage();
        }
    });
</script>

<script id="organisation-units-template" type="text/template">
    <ul id="organisation-unit-list" data-role="listview" data-inset="true">
        <% _( organisationUnits ).each( function(organisationUnit, idx) { %>
        <li><a href="#data-sets-page" data-id="<%= organisationUnit.id %>"><%= organisationUnit.name %></a></li>
        <% }); %>
    </ul>
</script>

<script id="data-sets-template" type="text/template">
    <ul id="data-set-list" data-role="listview" data-inset="true">
        <% _( dataSets ).each( function(dataSet, idx) { %>
        <li><a href="#period-page" data-id="<%= dataSet.id %>"><%= dataSet.name %></a></li>
        <% }); %>
    </ul>
</script>

<script id="period-template" type="text/template">
    <div data-role="controlgroup" data-type="horizontal">
        <button id="previous_year" data-icon="arrow-l">Previous Year</button>
        <button id="next_year" data-icon="arrow-r" data-iconpos="right">Next Year</button>
    </div>
    <ul id="period-list" data-role="listview" data-inset="true">
        <% _( periods ).each( function(period, idx) { %>
        <li><a href="#data-entry-page" data-id="<%= period.id %>"><%= period.name %></a></li>
        <% }); %>
    </ul>
</script>

<script id="data-entry-template" type="text/template">
    <h1><%= label %></h1>
    <form id='data-entry-form'>
    <ul id="data-entry-list" data-role="listview" data-inset="true">
        <% _( groups ).each( function(group, idx) { %>
            <li data-role="list-divider"><%= group.label %></li>

            <% _( group.fields ).each( function(field, idx) { %>
                <li>
                    <label for='<%= field.dataElement %>-<%= field.categoryOptionCombo %>'><%= field.label %></label>

                    <% if( field.type == 'TEXT' ) { %>
                        <input type="text" id='<%= field.dataElement %>-<%= field.categoryOptionCombo %>' maxlength="255" />
                    <% } else if( field.type == 'DATE' ) { %>
                        <input type="date" id='<%= field.dataElement %>-<%= field.categoryOptionCombo %>' maxlength="255" />
                    <% } else if( field.type == 'BOOLEAN' ) { %>
                        <select type="" id='<%= field.dataElement %>-<%= field.categoryOptionCombo %>' maxlength="255">
                            <option value="">None selected</option>
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
                        </select>
                    <% } else if( field.type == 'INTEGER' ) { %>
                        <input type="number" id='<%= field.dataElement %>-<%= field.categoryOptionCombo %>' maxlength="255" />
                    <% } else if( field.type == 'INTEGER_POSITIVE' ) { %>
                        <input type="number" id='<%= field.dataElement %>-<%= field.categoryOptionCombo %>' maxlength="255" />
                    <% } else if( field.type == 'INTEGER_NEGATIVE' ) { %>
                        <input type="number" id='<%= field.dataElement %>-<%= field.categoryOptionCombo %>' maxlength="255" />
                    <% } else if( field.type == 'NUMBER' ) { %>
                        <input type="number" id='<%= field.dataElement %>-<%= field.categoryOptionCombo %>' maxlength="255" />
                    <% } %>
                </li>
            <% }); %>

        <% }); %>
    </ul>
    </form>
</script>

<section data-role="page" id="organisation-units-page" data-theme="c">

	<header data-role="header" data-theme="b">
        <h1 align="center"><img src="$baseUrl/../dhis-web-commons/css/light_blue/logo_banner.png" /></h1>
        <a href="index" data-icon="back">Back</a>
	</header>

	<section data-role="content">
	</section>

    <footer data-role="footer" data-theme="b">
        <h1></h1>
   	</footer>

</section>

<section data-role="page" id="data-sets-page" data-theme="c">

	<header data-role="header" data-theme="b">
        <h1 align="center"><img src="$baseUrl/../dhis-web-commons/css/light_blue/logo_banner.png" /></h1>
        <a href="#organisation-units-page" data-icon="back">Back</a>
	</header>

	<section data-role="content">
	</section>

    <footer data-role="footer" data-theme="b">
        <h1></h1>
   	</footer>

</section>

<section data-role="page" id="period-page" data-theme="c">

	<header data-role="header" data-theme="b">
        <h1 align="center"><img src="$baseUrl/../dhis-web-commons/css/light_blue/logo_banner.png" /></h1>
        <a href="#data-sets-page" data-icon="back">Back</a>
	</header>

	<section data-role="content">
	</section>

    <footer data-role="footer" data-theme="b">
        <h1></h1>
   	</footer>

</section>

<section data-role="page" id="data-entry-page" data-theme="c">

	<header data-role="header" data-theme="b">
        <h1 align="center"><img src="$baseUrl/../dhis-web-commons/css/light_blue/logo_banner.png" /></h1>
        <a href="#period-page" data-icon="back">Back</a>
	</header>

	<section data-role="content">
	</section>

    <footer data-role="footer" data-theme="b">
        <h1></h1>
   	</footer>

</section>
