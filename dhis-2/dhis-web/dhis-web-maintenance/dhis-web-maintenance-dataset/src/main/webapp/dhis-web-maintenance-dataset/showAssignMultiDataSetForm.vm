<script>

	jQuery(document).ready(	function()
	{
		validation( 'assignMultiDataSetForm', confirmToSumbit );
	});

</script>

<h3>$i18n.getString( "dataset_assignment_editor" )</h3>

<form id="assignMultiDataSetForm" action="saveAssignMultiDataSetForOrgunit.action" method="POST">
<table>
	<tr>
		<th>$i18n.getString( "available_datasets" )</th><td></td><th>$i18n.getString( "selected_datasets" )</th>
	</tr>
	<tr>		
		<td><input type="text" id="availableDataSetsFilter" onkeyup="filterList( this.value, 'availableDataSets' )" style="width:25em" /></td>
		<td style="text-align:center">&lt; $i18n.getString( "filter" ) &gt;</td>
		<td><input type="text" id="selectedDataSetsFilter" onkeyup="filterList( this.value, 'selectedDataSets' )" style="width:25em" /></td>
	</tr>
	<tr>
		<td>
			<select id="availableDataSets" size="2" multiple="multiple" style="min-width:25em; height:25em" ondblclick="reloadTree( 'availableDataSets', 'selectedDataSets' )">
			#foreach( $dataSet in $availableDataSets )
				<option value="$dataSet.id">$dataSet.name</option>
			#end
			</select>
		</td>
		
		<td style="text-align:center">			
			<input type="button" value="&gt;" title="$i18n.getString('move_selected')" style="width:50px" onclick="reloadTree( 'availableDataSets', 'selectedDataSets' )" /><br/>
			<input type="button" value="&lt;" title="$i18n.getString('remove_selected')" style="width:50px" onclick="reloadTree( 'selectedDataSets', 'availableDataSets' )" /><br/>
			<input type="button" value="&gt;&gt;" title="$i18n.getString('move_all')" style="width:50px" onclick="reloadTree( 'availableDataSets', 'selectedDataSets', 'ALL' )"/><br/>
			<input type="button" value="&lt;&lt;" title="$i18n.getString('remove_all')" style="width:50px" onclick="reloadTree( 'selectedDataSets', 'availableDataSets', 'ALL' )"/>			
		</td>	
		<td>
			<select id="selectedDataSets" name="selectedDataSets" size="2" multiple="multiple" style="min-width:25em; height:25em" ondblclick="reloadTree( 'selectedDataSets', 'availableDataSets' )" class="{validate:{required:true}}"/>
		</td>
	</tr>	
</table>

<div><br/></div>
#organisationUnitSelectionTree( true, true, false )
<br/>

<table>
	<tr>
		<th>$i18n.getString( "optional" )</th>
	</tr>
	<tr><td>
		<input type="checkbox" id="assignStatus" name="assignStatus" value="true"/>$i18n.getString( "not_change_old_but_assign_new_only" )
	</td></tr>
</table>

<p>
	<input type="submit" value="$i18n.getString( 'save' )" style="width:10em"/>
	<input type="button" onclick="window.location.href='index.action'" value="$i18n.getString( 'cancel' )" style="width:10em"/>
</p>
</form>

<div id="warningArea" style="position:fixed;right:10px;top:200px;display:none">
	<div style="float:right">
		<a href="javascript:hideWarning()" title="$i18n.getString( 'hide_warning' )"><img src="../images/close.png" alt="$i18n.getString( 'hide_warning' )"/></a>
	</div>
	<p><span id="warningField"></span></p>
</div>

<span id="message" style="top:100px;right:5px;position:fixed;width:200px;z-index:10002" onclick="hideById(this.id);"></span>

<script type="text/javascript">

	#if ( $message )
		setMessage( '$i18n.getString( "$message" )' + '<br/><br/>[<strong>' + '$i18n.getString( "$name" ) </strong>]' );
	#end
	
	var confirmStatus = '';
	var i18n_add_success = '$encoder.jsEscape( $i18n.getString( "add_success" ) , "'")';
	var i18n_rename_success = '$encoder.jsEscape( $i18n.getString( "rename_success" ) , "'")';
	var i18n_confirm_delete = '$encoder.jsEscape( $i18n.getString( "confirm_delete" ) , "'")';
	var i18n_confirm_save = '$encoder.jsEscape( $i18n.getString( "confirm_save" ) , "'")';
	var i18n_dataset_unselected = '$encoder.jsEscape( $i18n.getString( "choose_dataset" ) , "'")';
	var i18n_datasets_different_orgunitlist = '$encoder.jsEscape( $i18n.getString( "datasets_different_orgunitlist" ) , "'")';
	
	// --------------------------------------------------------------
	// Methods
	// --------------------------------------------------------------
	
	function reloadTree( sourceListId, targetListId, typeMove )
	{
		if ( typeMove == undefined ) {
			moveSelectedById( sourceListId, targetListId );
		}
		else {
			moveAllById( sourceListId, targetListId );
		}
		reload();
	}
	
	function reload()
	{
		jQuery.post( "mergeAssignedOrgunits.action",
		{ selectedDataSets: getArrayValueOfListById( 'selectedDataSets' )
		},
		function( xml ){
			var responseLen = jQuery( xml ).find('unitId').length;
			var selectedListLen = byId('selectedDataSets').options.length;
			
			if ( responseLen == 0 )
			{
				confirmStatus = 'required';
				if ( selectedListLen != 0 )
				{
					setHeaderTimeDelayMessage( i18n_datasets_different_orgunitlist, 4500 );
				}
			}
			else
			{
				confirmStatus = '';
			}
			selectedOrganisationUnitXMLABCDEF( xml );
		});	
	}
	
	function confirmToSumbit()
	{
		var assignStatus = $("#assignStatus").is(':checked');
		
		if ( (confirmStatus != '') && !assignStatus ) {
		
			if ( window.confirm( i18n_confirm_save ) )
			{
				submitForm();
			}
			else return;
		}
		submitForm();
	}
	
	function submitForm()
	{
		selectAllById('selectedDataSets');
		byId('assignMultiDataSetForm').submit();
	}
	
</script>
