#macro( validate $type $require )
  #if( $type == "int" )
  	{validate:{ number:true #if($require), required:true #end }}
  #elseif( $type == "string" )
  	{validate:{ alphanumeric:true #if($require), required:true #end }}
  #elseif( $require )
  	{validate:{required:true}}
  #end
#end
<script>
jQuery(document).ready(function(){
	  //-----------------------------------------------------------------------
	  //init jQuery validation for updatePatientForm
	  //-----------------------------------------------------------------------
		jQuery("#updatePatientForm").validate({
			 meta:"validate"
			,errorElement:"td"
			,submitHandler: function(form)
							{
								validateUpdatePatient();
							}
		});
		jQuery.validator.setMessages( validationMessage );
		jQuery("#birthDate").rules("add",{required:true,dateISO:true,datelessthanequaltoday:true});
		jQuery("#firstName").focus();
		jQuery("#btnRepresentativeInfo").cluetip({local:"#representativeInfo"});
		
		datePickerValid( 'birthDate' );
});
</script>
<input type="hidden" id="curLocaleCode" value="$locale.getLanguage()_$locale.getCountry()"/>
<h3>$i18n.getString( "update_patient" )</h3>

<form id="updatePatientForm" action="updatePatient.action" method="post">
<input type="hidden" id="representativeId" name="representativeId"/> 
<input type="hidden" id="relationshipTypeId" name="relationshipTypeId"/>
<div>
	<input type="hidden" id="id" name="id" value="$patient.id">
</div>

<table>
	<tr><th colspan="2">$i18n.getString( "system_identifier" )</th></tr>
	<tr><td colspan="2" style="text-align: center">$systemIdentifier</td></tr>
	<tr><td>&nbsp;</td></tr>	
	<tr>
		<th colspan="2">$i18n.getString( "name" ) <em title="$i18n.getString( "required" )" class="required">*</em></th>
	</tr>
	<tr>
		<td><label for="firstName">$i18n.getString( "first_name" )</label></td>
		<td><input type="text" id="firstName" name="firstName" value="$encoder.htmlEncode( $patient.firstName )" style="width:30em" class="required_group {validate:{required_group:true,rangelength:[2,30]}}"></td>
	</tr>
	<tr>
		<td><label for="middleName">$i18n.getString( "middle_name" )</label></td>
		<td><input type="text" id="middleName" name="middleName" value="$encoder.htmlEncode( $patient.middleName )" style="width:30em" class="required_group {validate:{required_group:true,rangelength:[2,30]}}"></td>
	</tr>
	<tr>
		<td><label for="lastName">$i18n.getString( "last_name" )</label></td>
		<td><input type="text" id="lastName" name="lastName" value="$encoder.htmlEncode( $patient.lastName )" style="width:30em" class="required_group {validate:{required_group:true,rangelength:[2,30]}}"></td>
	</tr>
	<tr><td>&nbsp;</td></tr>	
	<tr>
		<th colspan="2">$i18n.getString( "demographics" )</th>
	</tr>
	<tr>
		<td><label for="gender">$i18n.getString( "gender" )<em title="$i18n.getString( "required" )" class="required">*</em></label></td>
		<td>
			<select id="gender" name="gender" style="min-width:20em">
				<option value="M" #if( $patient.gender == 'M' ) selected="selected" #end>$i18n.getString( "male" )</option>
				<option value="F" #if( $patient.gender == 'F' ) selected="selected" #end>$i18n.getString( "female" )</option>
			</select>
		</td>					
	</tr>	
	<tr>
		<td><label for="birthDate">$i18n.getString( "date_of_birth" )<em title="$i18n.getString( "required" )" class="required">*</em> </label></td>
		<td>
		    <input type="text" id="birthDate" name="birthDate" value="$format.formatDate( $patient.birthDate )" style="width:10em">
		    <!--<img src="../images/calendar_icon.gif" width="16" height="16" id="getBirthDate" style="cursor: pointer;" title="$i18n.getString("date_selector")" onmouseover="this.style.background='orange';" onmouseout="this.style.background=''" alt="$i18n.getString( "date_of_birth" )">-->		    
            &nbsp;&nbsp;&nbsp;
            <label for="estimated">$i18n.getString( "estimated" )</label>
            <input type="checkbox" id="birthDateEstimated" name="birthDateEstimated" value="true" #if( $patient.birthDateEstimated ) checked="checked" #end>
            &nbsp;
            <label for="age">$i18n.getString( "age" )</label>&nbsp;&nbsp;$encoder.htmlEncode( $patient.getAge() )            
        </td> 
	</tr>  
	<tr>
		<td><label for="bloodGroup">$i18n.getString( "blood_group" )</label></td>
		<td>
			<select type="text" id="bloodGroup" name="bloodGroup" style="width:30em" >
				 <option value="">[$i18n.getString( "please_select" )]</option>
				<option value="A+"  #if($patient.bloodGroup == "A+") selected="selected" #end>A+</option>
				<option value="A-"  #if($patient.bloodGroup == "A-") selected="selected" #end>A-</option>
				<option value="AB+" #if($patient.bloodGroup == "AB+") selected="selected" #end>AB+</option>
				<option value="AB-" #if($patient.bloodGroup == "AB-") selected="selected" #end>AB-</option>
				<option value="B+"  #if($patient.bloodGroup == "B+") selected="selected" #end>B+</option>
				<option value="B-"  #if($patient.bloodGroup == "B-") selected="selected" #end>B-</option>
				<option value="O+"  #if($patient.bloodGroup == "O+") selected="selected" #end>O+</option>
				<option value="O-"  #if($patient.bloodGroup == "O-") selected="selected" #end>O-</option>
			</select>
		</td>		
	</tr>
	<tr><td>&nbsp;</td></tr>	
	
	<!-- UNDERAGE -->
	
	<tr>
		<td>$i18n.getString("is_underage")</td>
		<td>
			<input type="checkbox" name="underAge" id="underAge" onclick="toggleUnderAge(this);" value="true" #if($patient.underAge) checked="checked" #end/>
		</td>
	</tr>
	#if($patient.underAge)
		#set( $representative = $patient.representative ) 
		<tr>
			<td>$i18n.getString("representative")</td>
			<td>$patient.representative.getFullName() <a title="$i18n.getString('patient_info')" href="#" id="btnRepresentativeInfo" rel="#representativeInfo"><img src="../images/information.png" alt="$i18n.getString( "show_details" )"></a></td>
			<script>jQuery("#btnRepresentativeInfo").cluetip({width:'350px'});</script>
		</tr>
	#end
	
	<!--IDENTIFIERS -->
	<tr><th colspan="2">$i18n.getString("patient_identifiers")</th></tr>
	#foreach ($identifierType in $identifierTypes)
	#set( $identifier = "" )
	#set( $identifier = $identiferMap.get( $identifierType.id ) )
	<tr>
			<td><label for="bloodGroup">$identifierType.name #if($identifierType.mandatory)<em title="$i18n.getString( "required" )" class="required">*</em> #end</label></td>
			<td><input type="text" id="iden$identifierType.id" name="iden$identifierType.id" value="$identifier" data="{related:$identifierType.related}" #if($identifierType.related && $patient.underAge) disabled="disabled" #end class='#validate( "default"  $identifierType.mandatory )' style="width:30em" /></td>	
	</tr>
	#end
	<tr><td>&nbsp;</td></tr>
	
	<!-- ATTRIBUTES IN GROUPS -->
	
	#foreach ($attributeGroup in $attributeGroups )
		<tr><td>&nbsp;</td></tr>	
		<tr><th colspan="2">$attributeGroup.name</th></tr>
		#foreach($attribute in $attributeGroup.attributes )
		#set( $attributeValue = "" )
		#set( $attributeValue = $patientAttributeValueMap.get( $attribute.id ) )
			<tr>
				<td><label>$attribute.name #if($attribute.mandatory)<em title="$i18n.getString( "required" )" class="required">*</em> #end</label></td>
				<td>
					#if( $attribute.valueType == "YES/NO" )
		                <select id="attr$attribute.id"  name="attr$attribute.id"  style="width:30em" >              
		                    <option value="">[$i18n.getString( "please_select" )]</option>
		                    <option value="true" #if( $attributeValue ) selected="selected" #end>$i18n.getString( "yes" )</option>
		                    <option value="false" #if( !$attributeValue ) selected="selected" #end>$i18n.getString( "no" )</option>
		                </select>                
		            #elseif( $attribute.valueType == "DATE" )
		                <input type="text" id="attr$attribute.id"  name="attr$attribute.id"  value="$!attributeValue" #validate( "date"  $attribute.mandatory ) style="width:30em" >
		                <script type="text/javascript">
                            datePickerValid( 'attr$attribute.id' );
                        </script>                 
					#elseif( $attribute.valueType == "COMBO" )
						<select  id="attr$attribute.id"  name="attr$attribute.id" #validate( "default"  $attribute.mandatory ) style="width:30em"  >
							 <option value="">[$i18n.getString( "please_select" )]</option>
						#foreach ($option in $attribute.attributeOptions )
							<option value="$option.id" #if($attributeValue == $option.name) selected="selected" #end>$option.name</option>
						#end
						</select>
					#else 
						<input type="text"  id="attr$attribute.id" name="attr$attribute.id" value="$!attributeValue" #validate( $attribute.valueType  $attribute.mandatory )   style="width:30em" >
					#end
				</td>		
			</tr>
		#end
	#end
	<tr><td>&nbsp;</td></tr>
	
	<!-- ATTRIBUTES NOT IN GROUPS -->
	
	#if ( $noGroupAttributes.size() > 0) 	
		<tr><th colspan="2">$i18n.getString( "Other details" )</th></tr>
		#foreach($attribute in $noGroupAttributes )
		#set( $attributeValue = "" )
		#set( $attributeValue = $patientAttributeValueMap.get( $attribute.id ) )
			<tr>
				<td><label>$attribute.name #if($attribute.mandatory)<em title="$i18n.getString( "required" )" class="required">*</em> #end</label></td>
				<td>
					#if( $attribute.valueType == "YES/NO" )
		                <select id="attr$attribute.id"  name="attr$attribute.id"   style="width:30em" >              
		                    <option value="">[$i18n.getString( "please_select" )]</option>
		                    <option value="true" #if( $attributeValue ) selected="selected" #end>$i18n.getString( "yes" )</option>
		                    <option value="false" #if( !$attributeValue ) selected="selected" #end>$i18n.getString( "no" )</option>
		                </select>                
		            #elseif( $attribute.valueType == "DATE" )
		                <input type="text" id="attr$attribute.id"    style="width:30em" name="attr$attribute.id"  value="$!attributeValue" #validate( ""  $attribute.mandatory )>
		                <script type="text/javascript">
                            datePickerValid( 'attr$attribute.id' );
                        </script>                    
					#elseif( $attribute.valueType == "COMBO" )
						<select  id="attr$attribute.id"  name="attr$attribute.id"  style="width:30em" #validate( "default"  $attribute.mandatory ) >
							 <option value="">[$i18n.getString( "please_select" )]</option>
						#foreach ($option in $attribute.attributeOptions )
							<option value="$option.id" #if($attributeValue == $option.name) selected="selected" #end>$option.name</option>
						#end
						</select>
					#else 
						<input type="text"  id="attr$attribute.id" name="attr$attribute.id" value="$!attributeValue" #validate( $attribute.valueType  $attribute.mandatory )   style="width:30em" >
					#end
				</td>		
			</tr>
		#end
	#end
</table>

<p>
	<input type="submit" value="$i18n.getString( "update" )" style="width:10em">
	<input type="button" value="$i18n.getString( "cancel" )" onclick="window.location.href='searchPatient.action'" style="width:10em">
</p>

</form> 	

<span id="message"></span>

<div id="hiddenModalContent" style="display:none">
<style> 
div#hiddenModalContent label { font-weight: bold;}  
div#hiddenModalContent td {padding: 2px 5px}
</style>
<span>$i18n.getString( "duplicate_warning" )</span>
<input type="button" value="$i18n.getString( 'create_new_patient' )"  id="btnCreateNew"/>
<script>function edit(this_){window.parent.tb_remove(); window.parent.location.href="showUpdatePatientForm.action?id="+jQuery(this_).attr("id");}
</script>
<div id="thickboxContainer"></div>
</div>
<script type="text/javascript">
        
        var i18n_patient_identifiers = '$encoder.jsEscape( $i18n.getString( "patient_identifiers" ) , "'")';
       	var i18n_patient_attributes = '$encoder.jsEscape( $i18n.getString( "patient_attributes" ) , "'")';
       	var i18n_patient_fullName = '$encoder.jsEscape( $i18n.getString( "full_name" ) , "'")';
       	var i18n_patient_demographics = '$encoder.jsEscape( $i18n.getString( "demographics" ) , "'")';
       	var i18n_patient_gender = '$encoder.jsEscape( $i18n.getString( "gender" ) , "'")';
       	var i18n_patient_date_of_birth = '$encoder.jsEscape( $i18n.getString( "date_of_birth" ) , "'")';
       	var i18n_patient_age = '$encoder.jsEscape( $i18n.getString( "age" ) , "'")';
       	var i18n_patient_blood_group = '$encoder.jsEscape( $i18n.getString( "blood_group" ) , "'")';
       	var i18n_edit_this_patient = '$encoder.jsEscape( $i18n.getString( "edit_this_patient" ) , "'")';
       	var i18n_no_duplicate_found = '$encoder.jsEscape( $i18n.getString( "no_duplicate_found" ) , "'")';
       	var i18n_patient_system_id = '$encoder.jsEscape( $i18n.getString( "patient_system_id" ) , "'")';
   		var i18n_child_representative = '$encoder.jsEscape( $i18n.getString( "child_representative" ) , "'")';
        var checkedDuplicate = false;
</script>

<div id="representativeInfo" style="display:none">
<table>
	<tr>
		<td><strong>$i18n.getString("full_name")</strong></td>
		<td>$representative.getFullName()</td>
	</tr>
	<tr>
		<td><strong>$i18n.getString("gender")</strong></td>
		<td> $representative.gender</td>
	</tr>
	<tr>
		<td><strong>$i18n.getString("birth_date")</strong></td>
		<td>$format.formatDate( $representative.birthDate )</td>
	</tr>
	<tr>
		<td><strong>$i18n.getString("age")</strong></td>
		<td> $representative.getAge() </td>
	</tr>
	<tr>
		<td><strong>$i18n.getString("blood_group")</strong></td>
		<td>$representative.getBloodGroup()</td>
	</tr>
	#foreach( $patientIdentifier in $representative.identifiers )
	  <tr>  
	  	<td><strong>#if( $patientIdentifier.identifierType )$patientIdentifier.identifierType.name #else $i18n.getString("system_identifier") #end</strong></td>      
	      <td> $patientIdentifier.identifier </td>
	   </tr>
	#end
	<tr>
		<td><strong>$i18n.getString("programs")</strong></td>
		<td>  
			 #foreach( $program in $representative.programs )
			 	#if( $velocityCount == 1 )
	      			 $program.name
	      		#else ,  $program.name 
	      		#end
			 #end  
		</td>
	</tr>
	       
</table>
</div>