<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd">
  
  <!-- DataMartStore -->
    
  <bean id="org.hisp.dhis.datamart.DataMartStore"
    class="org.hisp.dhis.datamart.jdbc.JdbcDataMartStore">
    <property name="statementManager" ref="statementManager"/>
    <property name="statementBuilder" ref="statementBuilder"/>
  </bean>
    
  <!-- DataMartExportStore -->
  
  <bean id="org.hisp.dhis.datamart.DataMartExportStore"
    class="org.hisp.dhis.hibernate.HibernateGenericStore">
    <property name="clazz" value="org.hisp.dhis.datamart.DataMartExport"/>   
    <property name="sessionFactory" ref="sessionFactory"/>
  </bean>
  
  <!-- DataMartService -->
  
  <bean id="org.hisp.dhis.datamart.DataMartService"
    class="org.hisp.dhis.datamart.impl.DefaultDataMartService">
	<property name="dataMartEngine"
	  ref="org.hisp.dhis.datamart.engine.DataMartEngine"/>
	<property name="dataMartStore"
	  ref="org.hisp.dhis.datamart.DataMartStore"/>
    <property name="dataMartExportStore"
      ref="org.hisp.dhis.datamart.DataMartExportStore"/>
  </bean>
  
  <!-- DataMartEngine -->
  
  <bean id="org.hisp.dhis.datamart.engine.DataMartEngine"
    class="org.hisp.dhis.datamart.engine.DefaultDataMartEngine">
    <property name="aggregationCache"
      ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache"/>
    <property name="dataMartStore"
	  ref="org.hisp.dhis.datamart.DataMartStore"/>
    <property name="crossTabService"
      ref="org.hisp.dhis.datamart.crosstab.CrossTabService"/>
    <property name="dataElementDataMart"
      ref="org.hisp.dhis.datamart.dataelement.DataElementDataMart"/>
    <property name="indicatorDataMart"
      ref="org.hisp.dhis.datamart.indicator.IndicatorDataMart"/>
    <property name="calculatedDataElementDataMart"
      ref="org.hisp.dhis.datamart.calculateddataelement.CalculatedDataElementDataMart"/>
    <property name="sumIntAggregator"
      ref="org.hisp.dhis.datamart.aggregation.dataelement.SumIntAggregator"/>
    <property name="averageIntAggregator"
      ref="org.hisp.dhis.datamart.aggregation.dataelement.AverageIntAggregator"/>
    <property name="sumBoolAggregator"
      ref="org.hisp.dhis.datamart.aggregation.dataelement.SumBoolAggregator"/>
    <property name="averageBoolAggregator"
      ref="org.hisp.dhis.datamart.aggregation.dataelement.AverageBoolAggregator"/>
    <property name="dataElementService"
      ref="org.hisp.dhis.dataelement.DataElementService"/>
    <property name="indicatorService"
      ref="org.hisp.dhis.indicator.IndicatorService"/>
    <property name="periodService"
      ref="org.hisp.dhis.period.PeriodService"/>
    <property name="categoryService"
      ref="org.hisp.dhis.dataelement.DataElementCategoryService"/>
    <property name="expressionService"
      ref="org.hisp.dhis.expression.ExpressionService"/>
  </bean>
  
  <bean id="internal-process-DataMart"
    class="org.hisp.dhis.datamart.DataMartInternalProcess"
    scope="prototype">
    <property name="statementManager" ref="statementManager"/>
    <property name="dataMartEngine"
      ref="org.hisp.dhis.datamart.engine.DataMartEngine"/>
  </bean>
  
  <!-- Crosstab -->
  
  <bean id="org.hisp.dhis.datamart.crosstab.jdbc.CrossTabStore"
    class="org.hisp.dhis.datamart.crosstab.jdbc.JDBCCrossTabStore">
    <property name="statementManager" ref="statementManager"/>
    <property name="statementBuilder" ref="statementBuilder"/>
  </bean>
  
  <bean id="org.hisp.dhis.datamart.crosstab.CrossTabService"
    class="org.hisp.dhis.datamart.crosstab.DefaultCrossTabService">
    <property name="batchHandlerFactory" ref="batchHandlerFactory"/>
    <property name="crossTabStore"
      ref="org.hisp.dhis.datamart.crosstab.jdbc.CrossTabStore"/>
    <property name="dataMartStore"
      ref="org.hisp.dhis.datamart.DataMartStore"/>
  </bean>
  
  <!-- AggregationCache -->
  
  <bean id="org.hisp.dhis.datamart.aggregation.cache.AggregationCache"
    class="org.hisp.dhis.datamart.aggregation.cache.MemoryAggregationCache">
    <property name="organisationUnitService"
      ref="org.hisp.dhis.organisationunit.OrganisationUnitService"/>
    <property name="periodService"
      ref="org.hisp.dhis.period.PeriodService"/>
  </bean>
  
  <!-- DataElementAggregator -->
  
  <bean id="org.hisp.dhis.datamart.aggregation.dataelement.SumIntAggregator"
    class="org.hisp.dhis.datamart.aggregation.dataelement.SumIntAggregator">
    <property name="dataMartStore"
      ref="org.hisp.dhis.datamart.DataMartStore"/>
    <property name="aggregationCache"
      ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache"/>
  </bean>
  
  <bean id="org.hisp.dhis.datamart.aggregation.dataelement.SumBoolAggregator"
    class="org.hisp.dhis.datamart.aggregation.dataelement.SumBoolAggregator">
    <property name="dataMartStore"
      ref="org.hisp.dhis.datamart.DataMartStore"/>
    <property name="aggregationCache"
      ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache"/>
  </bean>
  
  <bean id="org.hisp.dhis.datamart.aggregation.dataelement.AverageIntAggregator"
    class="org.hisp.dhis.datamart.aggregation.dataelement.AverageIntAggregator">
    <property name="dataMartStore"
      ref="org.hisp.dhis.datamart.DataMartStore"/>
    <property name="aggregationCache"
      ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache"/>
  </bean>

  <bean id="org.hisp.dhis.datamart.aggregation.dataelement.AverageBoolAggregator"
    class="org.hisp.dhis.datamart.aggregation.dataelement.AverageBoolAggregator">
    <property name="dataMartStore"
      ref="org.hisp.dhis.datamart.DataMartStore"/>
    <property name="aggregationCache"
      ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache"/>
  </bean>
  
  <!-- DataElementDataMart -->
  
  <bean id="org.hisp.dhis.datamart.dataelement.DataElementDataMart"
    class="org.hisp.dhis.datamart.dataelement.DefaultDataElementDataMart">
    <property name="organisationUnitService"
      ref="org.hisp.dhis.organisationunit.OrganisationUnitService"/>
    <property name="periodService"
      ref="org.hisp.dhis.period.PeriodService"/>
    <property name="batchHandlerFactory" ref="batchHandlerFactory"/>
    <property name="crossTabService"
      ref="org.hisp.dhis.datamart.crosstab.CrossTabService"/>
    <property name="aggregationCache"
      ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache"/>
  </bean>
  
  <!-- IndicatorDataMart -->
  
  <bean id="org.hisp.dhis.datamart.indicator.IndicatorDataMart"
    class="org.hisp.dhis.datamart.indicator.DefaultIndicatorDataMart">
    <property name="indicatorService"
      ref="org.hisp.dhis.indicator.IndicatorService"/>
    <property name="periodService"
      ref="org.hisp.dhis.period.PeriodService"/>
    <property name="organisationUnitService"
      ref="org.hisp.dhis.organisationunit.OrganisationUnitService"/>
    <property name="batchHandlerFactory" ref="batchHandlerFactory"/>
    <property name="sumIntAggregator"
      ref="org.hisp.dhis.datamart.aggregation.dataelement.SumIntAggregator"/>
    <property name="averageIntAggregator"
      ref="org.hisp.dhis.datamart.aggregation.dataelement.AverageIntAggregator"/>
    <property name="crossTabService"
      ref="org.hisp.dhis.datamart.crosstab.CrossTabService"/>
    <property name="dataElementService"
      ref="org.hisp.dhis.dataelement.DataElementService"/>
    <property name="aggregationCache"
      ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache"/>
    <property name="systemSettingManager"
      ref="org.hisp.dhis.options.SystemSettingManager"/>
  </bean>
  
  <!-- CalculatedDataElementDataMart -->

  <bean id="org.hisp.dhis.datamart.calculateddataelement.CalculatedDataElementDataMart"
    class="org.hisp.dhis.datamart.calculateddataelement.DefaultCalculatedDataElementDataMart">
    <property name="periodService"
      ref="org.hisp.dhis.period.PeriodService"/>
    <property name="organisationUnitService"
      ref="org.hisp.dhis.organisationunit.OrganisationUnitService"/>
    <property name="batchHandlerFactory" ref="batchHandlerFactory"/>
    <property name="sumIntAggregator"
      ref="org.hisp.dhis.datamart.aggregation.dataelement.SumIntAggregator"/>
    <property name="averageIntAggregator"
      ref="org.hisp.dhis.datamart.aggregation.dataelement.AverageIntAggregator"/>
    <property name="crossTabService"
      ref="org.hisp.dhis.datamart.crosstab.CrossTabService"/>
    <property name="dataElementService"
      ref="org.hisp.dhis.dataelement.DataElementService"/>
    <property name="categoryService"
      ref="org.hisp.dhis.dataelement.DataElementCategoryService"/>
    <property name="aggregationCache"
      ref="org.hisp.dhis.datamart.aggregation.cache.AggregationCache"/>
  </bean>
  
  <!-- DeletionHandler -->
  
  <bean id="org.hisp.dhis.datamart.DataMartExportDeletionHandler"
    class="org.hisp.dhis.datamart.DataMartExportDeletionHandler">
    <property name="dataMartService"
      ref="org.hisp.dhis.datamart.DataMartService"/>
  </bean>
  
  <!-- DeletionManager -->
  
  <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
    <property name="targetObject" ref="org.hisp.dhis.system.deletion.DeletionManager"/>
    <property name="targetMethod" value="addDeletionHandlers"/>
    <property name="arguments">
      <list>
        <list>
          <ref local="org.hisp.dhis.datamart.DataMartExportDeletionHandler"/>
        </list>
      </list>
    </property>
  </bean>
  
  <!-- Deletion AOP definitions -->
  
  <aop:config>
  
    <aop:aspect ref="deletionInterceptor">      
      <aop:before pointcut="execution( * org.hisp.dhis.datamart.DataMartService.deleteDataMartExport(..) )" method="intercept"/>
    </aop:aspect>
      
  </aop:config>
    
</beans>
