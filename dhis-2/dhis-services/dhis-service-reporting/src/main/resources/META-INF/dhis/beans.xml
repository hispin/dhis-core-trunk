<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:aop="http://www.springframework.org/schema/aop"
  xsi:schemaLocation="
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd">
  
  <!-- OLAP -->
  
  <bean id="org.hisp.dhis.olap.OlapURLStore"
    class="org.hisp.dhis.hibernate.HibernateGenericStore">
    <property name="clazz" value="org.hisp.dhis.olap.OlapURL"/>
    <property name="sessionFactory" ref="sessionFactory"/>
  </bean>
  
  <bean id="org.hisp.dhis.olap.OlapURLService"
    class="org.hisp.dhis.olap.DefaultOlapURLService">
    <property name="olapURLStore"
      ref="org.hisp.dhis.olap.OlapURLStore"/>
  </bean>
  
  <!-- ReportTable -->
  
  <bean id="internal-process-ReportTable"
    class="org.hisp.dhis.reporttable.ReportTableInternalProcess"
    scope="prototype">
    <property name="statementManager" ref="statementManager"/>
    <property name="reportTableService" 
        ref="org.hisp.dhis.reporttable.ReportTableService"/>
  </bean>
    
  <bean id="org.hisp.dhis.reporttable.jdbc.ReportTableManager"
    class="org.hisp.dhis.reporttable.jdbc.JDBCReportTableManager">
	<property name="statementBuilder" ref="statementBuilder"/>
  </bean>

  <bean id="org.hisp.dhis.reporttable.ReportTableStore"
    class="org.hisp.dhis.hibernate.HibernateGenericStore">
    <property name="clazz" value="org.hisp.dhis.reporttable.ReportTable"/>
    <property name="sessionFactory" ref="sessionFactory"/>
  </bean>
  
  <bean id="org.hisp.dhis.reporttable.ReportTableService"
    class="org.hisp.dhis.reporttable.impl.DefaultReportTableService">
    <property name="reportTableManager"
      ref="org.hisp.dhis.reporttable.jdbc.ReportTableManager"/>
    <property name="reportTableStore"
      ref="org.hisp.dhis.reporttable.ReportTableStore"/>
    <property name="reportService"
      ref="org.hisp.dhis.report.ReportService"/>
    <property name="periodService"
      ref="org.hisp.dhis.period.PeriodService"/>
    <property name="organisationUnitService"
      ref="org.hisp.dhis.organisationunit.OrganisationUnitService"/>
    <property name="batchHandlerFactory" ref="batchHandlerFactory"/>
    <property name="dataMartService"
      ref="org.hisp.dhis.datamart.DataMartService"/>
	<property name="aggregatedDataValueService"
	  ref="org.hisp.dhis.aggregation.AggregatedDataValueService"/>
    <property name="completenessService"
      ref="registrationDataCompletenessService"/>
  </bean>
  
  <!-- Report -->
  
  <bean id="org.hisp.dhis.report.ReportStore"
    class="org.hisp.dhis.hibernate.HibernateGenericStore">
    <property name="clazz" value="org.hisp.dhis.report.Report"/>
    <property name="sessionFactory" ref="sessionFactory"/>
  </bean>
  
  <bean id="org.hisp.dhis.report.ReportService"
    class="org.hisp.dhis.report.impl.DefaultReportService">
    <property name="reportStore"
      ref="org.hisp.dhis.report.ReportStore"/>
  </bean>
  
  <bean id="org.hisp.dhis.report.ReportManager"
    class="org.hisp.dhis.report.manager.DefaultReportManager">
    <property name="reportConfigDir" 
      value="reports"/>
    <property name="reportConfigFile" 
      value="reportConfiguration.xml"/>
  </bean>
  
  <!-- Chart -->
  
  <bean id="org.hisp.dhis.chart.ChartStore"
    class="org.hisp.dhis.chart.hibernate.HibernateChartStore">
    <property name="clazz" value="org.hisp.dhis.chart.Chart"/>
    <property name="sessionFactory" ref="sessionFactory"/>
  </bean>
  
  <bean id="org.hisp.dhis.chart.ChartService"
    class="org.hisp.dhis.chart.impl.DefaultChartService">
	<property name="aggregationService"
	  ref="org.hisp.dhis.aggregation.AggregationService"/>
    <property name="chartStore"
      ref="org.hisp.dhis.chart.ChartStore"/>
	<property name="periodService"
      ref="org.hisp.dhis.period.PeriodService"/>
	<property name="dataValueService"
	  ref="org.hisp.dhis.datavalue.DataValueService"/>
	<property name="minMaxDataElementService"
	  ref="org.hisp.dhis.minmax.MinMaxDataElementService"/>
  </bean>
  
  <!-- Document -->
    
  <bean id="org.hisp.dhis.document.DocumentStore"
    class="org.hisp.dhis.hibernate.HibernateGenericStore">
    <property name="clazz" value="org.hisp.dhis.document.Document"/>
    <property name="sessionFactory" ref="sessionFactory"/>
  </bean>
  
  <bean id="org.hisp.dhis.document.DocumentService"
    class="org.hisp.dhis.document.impl.DefaultDocumentService">
    <property name="documentStore"
      ref="org.hisp.dhis.document.DocumentStore"/>
  </bean>
  
  <!-- DataSetCompleteness -->
  
  <bean id="dataCompletenessServiceProvider"
	class="org.hisp.dhis.common.ServiceProvider">
    <property name="services">
	  <map>
        <entry>
          <key><value>registration</value></key>
          <ref bean="registrationDataCompletenessService"/>
        </entry>
        <entry>
          <key><value>compulsory</value></key>
          <ref bean="compulsoryDataCompletenessService"/>
        </entry>
        <entry>
          <key><value>ratio</value></key>
          <ref bean="ratioDataCompletenessService"/>
        </entry>		
	  </map>
    </property>
  </bean>
  
  <bean id="compulsoryDataCompletenessService"
	class="org.hisp.dhis.completeness.impl.CompulsoryDataSetCompletenessService">
    <property name="configDir" value="reports"/>
    <property name="configFile" value="dataSetCompletenessConfiguration.xml"/>
    <property name="batchHandlerFactory" ref="batchHandlerFactory"/>
    <property name="organisationUnitService"
      ref="org.hisp.dhis.organisationunit.OrganisationUnitService"/>
    <property name="dataSetService"
      ref="org.hisp.dhis.dataset.DataSetService"/>
	<property name="dataElementService"
	  ref="org.hisp.dhis.dataelement.DataElementService"/>
    <property name="periodService"
      ref="org.hisp.dhis.period.PeriodService"/>
    <property name="completenessStore"
      ref="org.hisp.dhis.completeness.DataSetCompletenessStore"/>
  </bean>
  
  <bean id="ratioDataCompletenessService"
	class="org.hisp.dhis.completeness.impl.RatioDataSetCompletenessService"
	parent="compulsoryDataCompletenessService"/>
  
  <bean id="registrationDataCompletenessService"
	class="org.hisp.dhis.completeness.impl.RegistrationDataSetCompletenessService" 
	parent="compulsoryDataCompletenessService">	
    <property name="registrationService"
      ref="org.hisp.dhis.dataset.CompleteDataSetRegistrationService"/>
  </bean>
  
  <bean id="org.hisp.dhis.completeness.DataSetCompletenessStore"
    class="org.hisp.dhis.completeness.jdbc.JDBCDataSetCompletenessStore"/>

  <bean id="internal-process-DataSetCompleteness"
    class="org.hisp.dhis.completeness.DataSetCompletenessInternalProcess"
    scope="prototype">
    <property name="statementManager" ref="statementManager"/>
    <property name="completenessService" ref="subjectiveDataCompletenessService"/>
  </bean>
  
  <!-- PDF -->
  
  <bean id="org.hisp.dhis.pdf.PdfService"
    class="org.hisp.dhis.pdf.impl.ItextPdfService">
    <property name="dataElementService"
      ref="org.hisp.dhis.dataelement.DataElementService"/>
    <property name="indicatorService"
      ref="org.hisp.dhis.indicator.IndicatorService"/>
    <property name="organisationUnitService"
      ref="org.hisp.dhis.organisationunit.OrganisationUnitService"/>
    <property name="expressionService"
      ref="org.hisp.dhis.expression.ExpressionService"/>
  </bean>
  
  <!-- Workbook -->
  
  <bean id="org.hisp.dhis.workbook.WorkbookService"
    class="org.hisp.dhis.workbook.impl.JExcelWorkbookService">   
    <property name="reportTableService"
      ref="org.hisp.dhis.reporttable.ReportTableService"/> 
    <property name="dataElementService"
      ref="org.hisp.dhis.dataelement.DataElementService"/>
    <property name="indicatorService"
      ref="org.hisp.dhis.indicator.IndicatorService"/>
    <property name="organisationUnitService"
      ref="org.hisp.dhis.organisationunit.OrganisationUnitService"/>   
  </bean>
  
  <!-- PivotTable -->
  
  <bean id="org.hisp.dhis.pivottable.PivotTableService"
    class="org.hisp.dhis.pivottable.impl.DefaultPivotTableService">
	<property name="aggregatedDataValueService"
	  ref="org.hisp.dhis.aggregation.AggregatedDataValueService"/>
    <property name="indicatorService" 
        ref="org.hisp.dhis.indicator.IndicatorService"/>
    <property name="periodService" 
        ref="org.hisp.dhis.period.PeriodService"/>
    <property name="organisationUnitService" 
        ref="org.hisp.dhis.organisationunit.OrganisationUnitService"/>
  </bean>
  
  <!-- DataSetReport -->
  
  <bean id="org.hisp.dhis.datasetreport.DataSetReportService"
	class="org.hisp.dhis.datasetreport.impl.DefaultDataSetReportService">
	<property name="dataValueService"
	  ref="org.hisp.dhis.datavalue.DataValueService"/>
	<property name="aggregationService"
	  ref="org.hisp.dhis.aggregation.AggregationService"/>
  </bean>
  
  <!-- Dashboard -->
      	
  <bean id="org.hisp.dhis.dashboard.DashboardContentStore"
    class="org.hisp.dhis.dashboard.hibernate.HibernateDashboardContentStore">
    <property name="clazz" value="org.hisp.dhis.dashboard.DashboardContent"/>
    <property name="sessionFactory" ref="sessionFactory"/>
  </bean>
  
  <bean id="org.hisp.dhis.dashboard.DashboardService"
    class="org.hisp.dhis.dashboard.impl.DefaultDashboardService">
    <property name="dashboardContentStore"
      ref="org.hisp.dhis.dashboard.DashboardContentStore"/>
  </bean>
  
  <bean id="org.hisp.dhis.tallysheet.TallySheetService"
    class="org.hisp.dhis.tallysheet.DefaultTallySheetService">
    <property name="dataValueService" 
      ref="org.hisp.dhis.datavalue.DataValueService"/>
  </bean>
  
  <bean id="org.hisp.dhis.tallysheet.TallySheetPdfService"
    class="org.hisp.dhis.tallysheet.DefaultTallySheetPdfService"/>
        
  <!-- Startup routine definitions -->
  
  <bean id="org.hisp.dhis.startup.OpenHealthDataSourceWriter"
    class="org.hisp.dhis.startup.OpenHealthDataSourceWriter">
    <property name="environmentVariable" value="OPENHEALTH_HOME"/>
    <property name="dataSourceFile" value="datasources.xml"/>
	<property name="name" value="OpenHealthDataSourceWriter"/>
    <property name="runlevel" value="6"/>
    <property name="skipInTests" value="true"/>
  </bean>
    
  <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
    <property name="targetObject"
      ref="org.hisp.dhis.system.startup.StartupRoutineExecutor"/>
    <property name="targetMethod" value="addStartupRoutines"/>
    <property name="arguments">
      <list>
        <ref local="org.hisp.dhis.startup.OpenHealthDataSourceWriter"/>
      </list>
    </property>
  </bean>

  <!-- DeletionHandler -->
  
  <bean id="org.hisp.dhis.report.ReportDeletionHandler"
    class="org.hisp.dhis.report.ReportDeletionHandler">
    <property name="reportService"
      ref="org.hisp.dhis.report.ReportService"/>
  </bean>
  
  <bean id="org.hisp.dhis.reporttable.ReportTableDeletionHandler"
    class="org.hisp.dhis.reporttable.ReportTableDeletionHandler">
    <property name="reportTableService"
      ref="org.hisp.dhis.reporttable.ReportTableService"/>
  </bean>
  
  <bean id="org.hisp.dhis.chart.ChartDeletionHandler"
    class="org.hisp.dhis.chart.ChartDeletionHandler">
    <property name="chartService"
      ref="org.hisp.dhis.chart.ChartService"/>
  </bean>
  
  <bean id="org.hisp.dhis.dashboard.DashboardContentDeletionHandler"
    class="org.hisp.dhis.dashboard.DashboardContentDeletionHandler">
    <property name="dashboardService"
      ref="org.hisp.dhis.dashboard.DashboardService"/>  
  </bean>
  
  <!-- DeletionManager -->
  
  <bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
    <property name="targetObject" ref="deletionManager"/>
    <property name="targetMethod" value="addDeletionHandlers"/>
    <property name="arguments">
      <list>
        <list>
          <ref local="org.hisp.dhis.report.ReportDeletionHandler"/>
          <ref local="org.hisp.dhis.reporttable.ReportTableDeletionHandler"/>
          <ref local="org.hisp.dhis.chart.ChartDeletionHandler"/>
          <ref local="org.hisp.dhis.dashboard.DashboardContentDeletionHandler"/>
        </list>
      </list>
    </property>
  </bean>
  
  <!-- AOP definitions -->
  
  <aop:config>
  
    <aop:aspect ref="deletionInterceptor">      
      <aop:before pointcut="execution( * org.hisp.dhis.reporttable.ReportTableService.delete*(..) )" method="intercept"/>
      <aop:before pointcut="execution( * org.hisp.dhis.report.ReportService.delete*(..) )" method="intercept"/>
      <aop:before pointcut="execution( * org.hisp.dhis.chart.ChartService.delete*(..) )" method="intercept"/>
      <aop:before pointcut="execution( * org.hisp.dhis.document.DocumentService.delete*(..) )" method="intercept"/>
    </aop:aspect>
      
    <aop:aspect ref="statementInterceptor">
      <aop:around pointcut="execution( * org.hisp.dhis.chart.ChartService.getJFreeChart(..) )" method="intercept"/>
      <aop:around pointcut="execution( * org.hisp.dhis.datasetreport.DataSetReportService.getAggregatedValueMap(..) )" method="intercept"/>
    </aop:aspect>
      
  </aop:config>
      
</beans>
