package require tcltest
namespace import ::tcltest::*

lappend auto_path mydatamart.vfs/libext
lappend auto_path mydatamart.vfs/libdhis

package require dhisweb
package require dhisdb
package require vfs::zip

set dbfile unittests/test.dmart
set db 0

proc dbsetup {} {
    sqlite3 db test.db
}

proc dbcleanup {} {
    db close
    file delete test.db
}

test createtables "Creating static tables" -body {
    dhisdb::loadTables db
    llength [dhisdb::getTables db]
} -result 20 -setup dbsetup -cleanup dbcleanup 

test loadMetadata "Loading dynamic data" -body {
    dhisdb::loadTables db
    dhisdb::evalFile db unittests/import.sql
    if [expr [dhisdb::haveOrgunits db]==0 ] {error "Orgunits not loaded"}
    dhisdb::generateViews db
    set expected [expr (([llength [dhisdb::getLevels db]]/2-1) * 2 * 4)+3]
    return [expr [llength [dhisdb::getViews db]] == $expected]
} -result 1 -setup dbsetup -cleanup dbcleanup 





    
 