package require tcltest
namespace import ::tcltest::*

lappend auto_path datamart.vfs/libext
lappend auto_path datamart.vfs/libdhis

package require dhisweb

${::dhisweb::log}::setlevel debug

${::dhisweb::log}::debug "Hello from the logger"
${::dhisweb::log}::trace add -ns ::dhisweb
${::dhisweb::log}::trace on

set ::dhis(dbfile) utest.dmart

#set testhost http://hiskenya.org
#set testhost http://192.168.1.11:8082
#set testhost http://127.0.0.1:8082
set testhost https://dhis.uio.no/demo

set username admin
set password district

set tmpfile [file join

test fetch "Fetch metadata" -body {
    catch {sqlite3 dataconn $::dhis(dbfile)} err
    puts $err
    
    try {
    	set outchan [open $tmpfile w+]
	dhisweb::login $::testhost $username $password 5000
	vwait ::dhisweb::loginstatus
	puts "login status: $::dhisweb::loginstatus"
	
	# make a db connection	    
	set tok [dhisweb::fetchMetadata $testhost $outchan]
	
	vwait ::dhisweb::metadatastatus
    } on error err {
	puts "ouch $err"
    } finally {
	close $outchan
	return $::dhisweb::metadatastatus
    }
	
} -result SUCCESS

    

	    